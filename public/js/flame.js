/* esm.sh - esbuild bundle(flamethrower-router@0.0.0-meme.7) es2022 production */
function m(n){["link","go"].includes(n)&&window.scrollTo({top:0})}function a(n){let e=new URL(n||window.location.href).href;return e.endsWith("/")||e.includes(".")?e:`${e}/`}function g(n){(!window.history.state||window.history.state.url!==n)&&window.history.pushState({url:n},"internalLink",n)}function v(n){document.querySelector(n).scrollIntoView({behavior:"smooth",block:"start"})}function y(n){let e=a();return{type:"popstate",next:e}}function b(n){let e;if(n.altKey||n.ctrlKey||n.metaKey||n.shiftKey)return{type:"disqualified"};for(var t=n.target;t.parentNode;t=t.parentNode)if(t.nodeName==="A"){e=t;break}if(e&&e.host!==location.host)return e.target="_blank",{type:"external"};if(e&&"cold"in e?.dataset)return{type:"disqualified"};if(e!=null&&e.hasAttribute("href")){let r=e.getAttribute("href"),o=new URL(r,location.href);if(n.preventDefault(),r!=null&&r.startsWith("#"))return v(r),{type:"scrolled"};let i=a(o.href),s=a();return{type:"link",next:i,prev:s}}else return{type:"noop"}}function E(n){return new DOMParser().parseFromString(n,"text/html")}function f(n){document.body.replaceWith(n.body)}function k(n){let e=s=>Array.from(s.querySelectorAll('head>:not([rel="prefetch"]')),t=e(document),r=e(n),{staleNodes:o,freshNodes:i}=F(t,r);o.forEach(s=>s.remove()),document.head.append(...i)}function F(n,e){let t=[],r=[],o=0,i=0;for(;o<n.length&&i<e.length;){let s=n[o],c=e[i];if(s.isEqualNode(c)){o++,i++;continue}let u=r.findIndex(l=>l.isEqualNode(s));if(u!==-1){r.splice(u,1),o++;continue}let d=t.findIndex(l=>l.isEqualNode(c));if(d!==-1){t.splice(d,1),i++;continue}s&&t.push(s),c&&r.push(c),o++,i++}return{staleNodes:t,freshNodes:r}}function p(){document.head.querySelectorAll("[data-reload]").forEach(w),document.body.querySelectorAll("script").forEach(w)}function w(n){let e=document.createElement("script"),t=Array.from(n.attributes);for(let{name:r,value:o}of t)e[r]=o;e.append(n.textContent),n.replaceWith(e)}var L={log:!1,pageTransitions:!1},h=class{constructor(e){this.opts=e,this.enabled=!0,this.prefetched=new Set,this.opts={...L,...e??{}},window!=null&&window.history?(document.addEventListener("click",t=>this.onClick(t)),window.addEventListener("popstate",t=>this.onPop(t)),this.prefetch()):(console.warn("flamethrower router not supported in this browser or environment"),this.enabled=!1)}go(e){let t=window.location.href,r=new URL(e,location.origin).href;return this.reconstructDOM({type:"go",next:r,prev:t})}back(){window.history.back()}forward(){window.history.forward()}get allLinks(){return Array.from(document.links).filter(e=>e.href.includes(document.location.origin)&&!e.href.includes("#")&&e.href!==(document.location.href||document.location.href+"/")&&!this.prefetched.has(e.href))}log(...e){this.opts.log&&console.log(...e)}prefetch(){if(this.opts.prefetch==="visible")this.prefetchVisible();else if(this.opts.prefetch==="hover")this.prefetchOnHover();else return}prefetchOnHover(){this.allLinks.forEach(e=>{let t=e.getAttribute("href");e.addEventListener("pointerenter",()=>this.createLink(t),{once:!0})})}prefetchVisible(){let e={root:null,rootMargin:"0px",threshold:1};"IntersectionObserver"in window&&(this.observer||(this.observer=new IntersectionObserver((t,r)=>{t.forEach(o=>{let i=o.target.getAttribute("href");if(this.prefetched.has(i)){r.unobserve(o.target);return}o.isIntersecting&&(this.createLink(i),r.unobserve(o.target))})},e)),this.allLinks.forEach(t=>this.observer.observe(t)))}createLink(e){let t=document.createElement("link");t.rel="prefetch",t.href=e,t.as="document",t.onload=()=>this.log("\u{1F329}\uFE0F prefetched",e),t.onerror=r=>this.log("\u{1F915} can't prefetch",e,r),document.head.appendChild(t),this.prefetched.add(e)}onClick(e){this.reconstructDOM(b(e))}onPop(e){this.reconstructDOM(y())}async reconstructDOM({type:e,next:t,prev:r}){if(!this.enabled){this.log("router disabled");return}try{if(this.log("\u26A1",e),["popstate","link","go"].includes(e)&&t!==r){this.opts.log&&console.time("\u23F1\uFE0F"),window.dispatchEvent(new CustomEvent("flamethrower:router:fetch")),g(t);let o=await(await fetch(t,{headers:{"X-Flamethrower":"1"}})).text(),i=E(o);k(i),this.opts.pageTransitions&&document.createDocumentTransition?document.createDocumentTransition().start(()=>{f(i),p()}):(f(i),p()),m(e),window.dispatchEvent(new CustomEvent("flamethrower:router:end")),setTimeout(()=>{this.prefetch()},200),this.opts.log&&console.timeEnd("\u23F1\uFE0F")}}catch(o){return window.dispatchEvent(new CustomEvent("router:error",o)),this.opts.log&&console.timeEnd("\u23F1\uFE0F"),console.error("\u{1F4A5} router fetch failed",o),!1}}},x=n=>{let e=new h(n);if(n.log&&console.log("\u{1F525} flamethrower engaged"),window){let t=window;t.flamethrower=e}return e};export{x as default};
